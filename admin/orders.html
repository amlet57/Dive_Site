<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление заказами | DiveGear Admin</title>
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    
    <style>
        :root {
            --dg-primary: #0a3142;
            --dg-secondary: #1f6e8a;
        }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f4f7fb;
        }
        
        .sidebar {
            background: linear-gradient(180deg, var(--dg-primary) 0%, #0e2a38 100%);
            min-height: 100vh;
            color: white;
        }
        
        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 1rem 1.5rem;
            margin: 0.2rem 0;
            border-radius: 0 30px 30px 0;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: rgba(255,255,255,0.15);
            color: white;
        }
        
        .main-content {
            padding: 2rem;
        }
        
        .orders-table-container {
            background: white;
            border-radius: 25px;
            padding: 1.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.02);
        }
        
        .filter-section {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .badge-new { background: #ffc107; color: #000; padding: 0.5rem 1rem; border-radius: 50px; }
        .badge-processing { background: #17a2b8; color: white; padding: 0.5rem 1rem; border-radius: 50px; }
        .badge-completed { background: #28a745; color: white; padding: 0.5rem 1rem; border-radius: 50px; }
        .badge-cancelled { background: #dc3545; color: white; padding: 0.5rem 1rem; border-radius: 50px; }
        
        .btn-action {
            padding: 0.25rem 0.8rem;
            border-radius: 50px;
            margin: 0 0.2rem;
        }
        
        .export-btn {
            background: var(--dg-secondary);
            color: white;
            border-radius: 50px;
            padding: 0.6rem 1.5rem;
            border: none;
        }
        
        .export-btn:hover {
            background: var(--dg-primary);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Боковая панель -->
            <div class="col-md-3 col-lg-2 px-0 sidebar">
                <div class="sidebar-header">
                    <h4 class="text-white mb-1"><i class="bi bi-water"></i> DiveGear</h4>
                    <p class="text-white-50 small mb-0">Управление заказами</p>
                </div>
                
                <div class="mt-3">
                    <nav class="nav flex-column">
                        <a class="nav-link" href="dashboard.html">
                            <i class="bi bi-speedometer2"></i>Дашборд
                        </a>
                        <a class="nav-link active" href="orders.html">
                            <i class="bi bi-box-seam"></i>Заказы
                        </a>
                        <a class="nav-link" href="#" onclick="logout()">
                            <i class="bi bi-box-arrow-right"></i>Выход
                        </a>
                    </nav>
                </div>
            </div>
            
            <!-- Основной контент -->
            <div class="col-md-9 col-lg-10 main-content">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold" style="color: var(--dg-primary);">Управление заказами</h2>
                    <button class="export-btn" onclick="exportOrders()">
                        <i class="bi bi-download me-2"></i>Экспорт в CSV
                    </button>
                </div>
                
                <!-- Фильтры -->
                <div class="filter-section">
                    <div style="flex: 1; min-width: 200px;">
                        <label class="form-label fw-bold">Статус</label>
                        <select class="form-select" id="statusFilter" onchange="filterOrders()">
                            <option value="all">Все статусы</option>
                            <option value="new">Новые</option>
                            <option value="processing">В обработке</option>
                            <option value="completed">Выполненные</option>
                            <option value="cancelled">Отмененные</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label class="form-label fw-bold">Дата от</label>
                        <input type="date" class="form-control" id="dateFrom" onchange="filterOrders()">
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label class="form-label fw-bold">Дата до</label>
                        <input type="date" class="form-control" id="dateTo" onchange="filterOrders()">
                    </div>
                    <div>
                        <button class="btn btn-outline-secondary rounded-pill px-4" onclick="clearFilters()">
                            <i class="bi bi-x-circle"></i> Сброс
                        </button>
                    </div>
                </div>
                
                <!-- Таблица заказов -->
                <div class="orders-table-container">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="ordersTable">
                            <thead>
                                <tr>
                                    <th>№ заказа</th>
                                    <th>Дата</th>
                                    <th>Клиент</th>
                                    <th>Телефон</th>
                                    <th>Товар</th>
                                    <th>Размер</th>
                                    <th>Кол-во</th>
                                    <th>Статус</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <!-- Данные загружаются через JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно редактирования -->
    <div class="modal fade" id="editOrderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Редактирование заказа</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editOrderForm">
                        <input type="hidden" id="editOrderNumber">
                        <div class="mb-3">
                            <label class="form-label">Статус заказа</label>
                            <select class="form-select" id="editStatus">
                                <option value="new">Новый</option>
                                <option value="processing">В обработке</option>
                                <option value="completed">Выполнен</option>
                                <option value="cancelled">Отменен</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Комментарий</label>
                            <textarea class="form-control" id="editComment" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="saveOrderChanges()">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    
    <script>
        // Проверка авторизации
        if (!sessionStorage.getItem('admin_logged_in')) {
            window.location.href = 'login.html';
        }

        let ordersData = [];
        let dataTable = null;

        // Загрузка заказов
        document.addEventListener('DOMContentLoaded', function() {
            loadOrders();
        });

        function loadOrders() {
            ordersData = JSON.parse(localStorage.getItem('divegear_orders')) || [];
            renderTable(ordersData);
        }

        function renderTable(data) {
            const tableBody = document.getElementById('ordersTableBody');
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-5">Заказы не найдены</td></tr>';
                return;
            }
            
            // Сортируем по дате (новые сверху)
            data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            data.forEach(order => {
                const row = document.createElement('tr');
                const createdDate = new Date(order.created_at).toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                row.innerHTML = `
                    <td><strong>${order.order_number || 'Н/Д'}</strong></td>
                    <td>${createdDate}</td>
                    <td>${order.customer_name || 'Н/Д'}</td>
                    <td>${order.customer_phone || 'Н/Д'}</td>
                    <td>${order.clothing_type || 'Н/Д'}</td>
                    <td>${order.size || 'Н/Д'}</td>
                    <td>${order.quantity || 0}</td>
                    <td>${getStatusBadge(order.status || 'new')}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary btn-action" onclick="viewOrder('${order.order_number}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning btn-action" onclick="editOrder('${order.order_number}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteOrder('${order.order_number}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Инициализируем DataTable
            if (dataTable) {
                dataTable.destroy();
            }
            dataTable = $('#ordersTable').DataTable({
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/ru.json'
                },
                pageLength: 20,
                order: [[1, 'desc']]
            });
        }

        function getStatusBadge(status) {
            const statuses = {
                'new': '<span class="badge-new"><i class="bi bi-star-fill me-1"></i>Новый</span>',
                'processing': '<span class="badge-processing"><i class="bi bi-gear-fill me-1"></i>В обработке</span>',
                'completed': '<span class="badge-completed"><i class="bi bi-check-circle-fill me-1"></i>Выполнен</span>',
                'cancelled': '<span class="badge-cancelled"><i class="bi bi-x-circle-fill me-1"></i>Отменен</span>'
            };
            return statuses[status] || statuses['new'];
        }

        function filterOrders() {
            const status = document.getElementById('statusFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            let filtered = [...ordersData];
            
            if (status !== 'all') {
                filtered = filtered.filter(o => o.status === status);
            }
            
            if (dateFrom) {
                const from = new Date(dateFrom);
                filtered = filtered.filter(o => new Date(o.created_at) >= from);
            }
            
            if (dateTo) {
                const to = new Date(dateTo);
                to.setHours(23, 59, 59);
                filtered = filtered.filter(o => new Date(o.created_at) <= to);
            }
            
            renderTable(filtered);
        }

        function clearFilters() {
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            renderTable(ordersData);
        }

        function viewOrder(orderNumber) {
            const order = ordersData.find(o => o.order_number === orderNumber);
            if (order) {
                alert(`
                    Заказ: ${order.order_number}
                    Клиент: ${order.customer_name}
                    Телефон: ${order.customer_phone}
                    Адрес: ${order.delivery_address}
                    Товар: ${order.clothing_type}
                    Размер: ${order.size}
                    Количество: ${order.quantity}
                    Комментарий: ${order.comment || 'Нет'}
                    Дата: ${new Date(order.created_at).toLocaleString('ru-RU')}
                `);
            }
        }

        function editOrder(orderNumber) {
            const order = ordersData.find(o => o.order_number === orderNumber);
            if (order) {
                document.getElementById('editOrderNumber').value = order.order_number;
                document.getElementById('editStatus').value = order.status || 'new';
                document.getElementById('editComment').value = order.comment || '';
                
                const modal = new bootstrap.Modal(document.getElementById('editOrderModal'));
                modal.show();
            }
        }

        function saveOrderChanges() {
            const orderNumber = document.getElementById('editOrderNumber').value;
            const newStatus = document.getElementById('editStatus').value;
            const newComment = document.getElementById('editComment').value;
            
            const index = ordersData.findIndex(o => o.order_number === orderNumber);
            if (index !== -1) {
                ordersData[index].status = newStatus;
                ordersData[index].comment = newComment;
                
                localStorage.setItem('divegear_orders', JSON.stringify(ordersData));
                
                bootstrap.Modal.getInstance(document.getElementById('editOrderModal')).hide();
                loadOrders();
            }
        }

        function deleteOrder(orderNumber) {
            if (confirm('Вы уверены, что хотите удалить заказ?')) {
                ordersData = ordersData.filter(o => o.order_number !== orderNumber);
                localStorage.setItem('divegear_orders', JSON.stringify(ordersData));
                loadOrders();
            }
        }

        function exportOrders() {
            const data = ordersData.map(o => [
                o.order_number,
                new Date(o.created_at).toLocaleDateString('ru-RU'),
                o.customer_name,
                o.customer_phone,
                o.clothing_type,
                o.size,
                o.quantity,
                o.status,
                o.delivery_address,
                o.comment || ''
            ]);
            
            const csvContent = [
                ['Номер заказа', 'Дата', 'ФИО', 'Телефон', 'Товар', 'Размер', 'Количество', 'Статус', 'Адрес', 'Комментарий'],
                ...data
            ].map(row => row.join(';')).join('\n');
            
            const blob = new Blob(["\ufeff" + csvContent], {type: 'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.setAttribute('download', 'divegear_orders_' + new Date().toISOString().slice(0,10) + '.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function logout() {
            sessionStorage.removeItem('admin_logged_in');
            sessionStorage.removeItem('admin_username');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>